---
import { Icon } from "astro-icon/components";
import { siteConfig } from "../../config";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import {
	getCategoryList,
	getSortedPosts,
	getTagList,
} from "../../utils/content-utils";
import WidgetLayout from "./WidgetLayout.astro";

interface Props {
	class?: string;
	style?: string;
}

const { class: className, style } = Astro.props;

// 从配置中获取站点开始日期
const siteStartDate = siteConfig.siteStartDate || "2025-01-01";

// 获取所有文章
const posts = await getSortedPosts();
const categories = await getCategoryList();
const tags = await getTagList();

// 计算总字数
let totalWords = 0;
for (const post of posts) {
	if (post.body) {
		let text = post.body;

		// 移除代码块
		text = text.replace(/```[\s\S]*?```/g, "");
		// 移除 ` 包裹的行内代码
		text = text.replace(/`[^`]+`/g, "");

		// 使用与 remark-content.mjs 完全一致的 CJK 正则
		const cjkPattern =
			/[\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af\u3000-\u303f\uff00-\uffef]/g;

		const cjkMatches = text.match(cjkPattern);
		const cjkCount = cjkMatches ? cjkMatches.length : 0;

		// 计算非 CJK 单词数
		const nonCjkText = text.replace(cjkPattern, " ");

		// 按空白字符分割，计算单词数量
		const nonCjkWords = nonCjkText
			.split(/\s+/)
			.filter((word) => word.trim().length > 0);

		totalWords += cjkCount + nonCjkWords.length;
	}
}

// 格式化数字（添加千位分隔符）
function formatNumber(num: number): string {
	return num.toLocaleString();
}

// 获取最新文章日期（忽略置顶状态，只按发布日期排序）
const latestPost = posts.reduce((latest, post) => {
	if (!latest) return post;
	return post.data.published > latest.data.published ? post : latest;
}, posts[0]);

const lastPostDate = latestPost
	? latestPost.data.published.toISOString()
	: null;

const stats = [
	{
		icon: "material-symbols:article-outline",
		label: i18n(I18nKey.siteStatsPostCount),
		value: posts.length,
	},
	{
		icon: "material-symbols:folder-outline",
		label: i18n(I18nKey.siteStatsCategoryCount),
		value: categories.length,
	},
	{
		icon: "material-symbols:label-outline",
		label: i18n(I18nKey.siteStatsTagCount),
		value: tags.length,
	},
	{
		icon: "material-symbols:text-ad-outline-rounded",
		label: i18n(I18nKey.siteStatsTotalWords),
		value: totalWords,
		formatted: true,
	},
	{
		icon: "material-symbols:calendar-clock-outline",
		label: i18n(I18nKey.siteStatsRunningDays),
		value: 0,
		suffix: i18n(I18nKey.siteStatsDays).replace("{days}", ""),
		dynamic: true,
		id: "running-days",
	},
	{
		icon: "material-symbols:ecg-heart-outline",
		label: i18n(I18nKey.siteStatsLastUpdate),
		value: 0,
		suffix: i18n(I18nKey.siteStatsDaysAgo).replace("{days}", ""),
		dynamic: true,
		id: "last-update",
	},
	{
		icon: "material-symbols:calendar-month-outline",
		label: i18n(I18nKey.siteStatsCurrentDate),
		value: 0,
		dynamic: true,
		id: "current-date",
		dateFormat: i18n(I18nKey.siteStatsDateFormat), // 完整的日期格式模板
	},
	{
		icon: "material-symbols:schedule-outline",
		label: i18n(I18nKey.siteStatsCurrentTime),
		value: 0,
		dynamic: true,
		id: "current-time",
		ampm: false, // 启用12小时制（默认为false，24小时制）
	},
];
---

<WidgetLayout
	name={i18n(I18nKey.siteStats)}
	id="site-stats"
	class={className}
	style={style}
>
	<div class="flex flex-col gap-1">
		{
			stats.map((stat) => (
				<div class="flex items-center justify-between px-2 py-2">
					<div class="flex items-center gap-2.5 flex-1 min-w-0">
						<div class="text-[var(--primary)] text-xl shrink-0">
							<Icon name={stat.icon} />
						</div>
						<span class="text-neutral-700 dark:text-neutral-300 font-medium text-sm break-words leading-tight">
							{stat.label}
						</span>
					</div>
					<div class="flex items-center ml-3 shrink-0">
						<span
							class="text-base font-bold text-neutral-900 dark:text-neutral-100"
							data-stat-id={stat.id}
							data-ampm={stat.ampm}
							data-date-format={stat.dateFormat}
						>
							{stat.formatted
								? formatNumber(stat.value)
								: stat.value}
						</span>
						{stat.suffix && (
							<span class="text-sm text-neutral-500 dark:text-neutral-400 ml-1">
								{stat.suffix}
							</span>
						)}
					</div>
				</div>
			))
		}
	</div>
</WidgetLayout>

<script is:inline define:vars={{ siteStartDate, lastPostDate }}>
	// 格式化时间（12小时制，带 AM/PM）
	function formatTimeWithAMPM(date) {
		let hours = date.getHours();
		const minutes = String(date.getMinutes()).padStart(2, '0');
		const seconds = String(date.getSeconds()).padStart(2, '0');
		const ampm = hours >= 12 ? 'PM' : 'AM';
		
		hours = hours % 12;
		hours = hours ? hours : 12;
		
		return `${hours}:${minutes}:${seconds} ${ampm}`;
	}

	// 格式化时间（24小时制）
	function formatTime24(date) {
		const hours = String(date.getHours()).padStart(2, '0');
		const minutes = String(date.getMinutes()).padStart(2, '0');
		const seconds = String(date.getSeconds()).padStart(2, '0');
		return `${hours}:${minutes}:${seconds}`;
	}

	// 解析日期格式模板
	function parseDateFormat(template, date) {
		const year = date.getFullYear();
		const month = date.getMonth() + 1;
		const day = date.getDate();
		
		const parts = [];
		let lastIndex = 0;
		
		const placeholders = [
			{ name: 'year', value: year, index: template.indexOf('{year}') },
			{ name: 'month', value: month, index: template.indexOf('{month}') },
			{ name: 'day', value: day, index: template.indexOf('{day}') }
		];
		
		const validPlaceholders = placeholders
			.filter(ph => ph.index !== -1)
			.sort((a, b) => a.index - b.index);
		
		for (let i = 0; i < validPlaceholders.length; i++) {
			const ph = validPlaceholders[i];
			
			if (ph.index > lastIndex) {
				parts.push({
					type: 'text',
					content: template.substring(lastIndex, ph.index)
				});
			}
			
			parts.push({
				type: 'number',
				content: ph.value.toString(),
				name: ph.name
			});
			
			lastIndex = ph.index + `{${ph.name}}`.length;
		}
		
		if (lastIndex < template.length) {
			parts.push({
				type: 'text',
				content: template.substring(lastIndex)
			});
		}
		
		return parts;
	}

	function updateDynamicStats() {
		const today = new Date();

		// 更新运行天数
		const startDate = new Date(siteStartDate);
		const diffTime = Math.abs(today.getTime() - startDate.getTime());
		const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

		const runningDaysElement = document.querySelector(
			'[data-stat-id="running-days"]',
		);
		if (runningDaysElement) {
			runningDaysElement.textContent = diffDays.toString();
		}

		// 更新最后活动时间
		if (lastPostDate) {
			const lastPost = new Date(lastPostDate);
			const timeSinceLastPost = Math.abs(
				today.getTime() - lastPost.getTime(),
			);
			const daysSinceLastUpdate = Math.floor(
				timeSinceLastPost / (1000 * 60 * 60 * 24),
			);

			const lastUpdateElement = document.querySelector(
				'[data-stat-id="last-update"]',
			);
			if (lastUpdateElement) {
				lastUpdateElement.textContent = daysSinceLastUpdate.toString();
			}
		}

		// 更新当前日期
		const currentDateElement = document.querySelector(
			'[data-stat-id="current-date"]',
		);
		if (currentDateElement) {
			const dateFormat = currentDateElement.getAttribute('data-date-format');
			if (dateFormat) {
				const parts = parseDateFormat(dateFormat, today);
				
				// 检查是否有后缀span
				const suffixSpan = currentDateElement.nextElementSibling;
				
				if (suffixSpan && suffixSpan.classList.contains('ml-1')) {
					// 临时移除suffixSpan的类，避免影响子元素
					const originalClasses = suffixSpan.className;
					suffixSpan.className = 'ml-1'; // 只保留间距，移除所有样式类
					
					// 清空suffixSpan
					suffixSpan.innerHTML = '';
					
					// 创建容器来包裹所有内容
					parts.forEach(part => {
						if (part.type === 'number') {
							// 数字部分：使用粗体样式
							const span = document.createElement('span');
							span.className = 'text-base font-bold text-neutral-900 dark:text-neutral-100';
							span.textContent = part.content;
							suffixSpan.appendChild(span);
						} else {
							// 文本部分：使用小号灰色字体
							const span = document.createElement('span');
							span.className = 'text-sm text-neutral-500 dark:text-neutral-400';
							span.textContent = part.content;
							suffixSpan.appendChild(span);
						}
					});
					
					// 清空数值span
					currentDateElement.innerHTML = '';
				} else {
					// 如果没有后缀span，创建一个新的容器
					const container = document.createElement('span');
					container.className = 'ml-1';
					
					// 清空currentDateElement并隐藏它
					currentDateElement.innerHTML = '';
					currentDateElement.style.display = 'none';
					
					// 将container添加到父元素中
					currentDateElement.parentElement.appendChild(container);
					
					// 在container中构建显示
					parts.forEach(part => {
						if (part.type === 'number') {
							const span = document.createElement('span');
							span.className = 'text-base font-bold text-neutral-900 dark:text-neutral-100';
							span.textContent = part.content;
							container.appendChild(span);
						} else {
							const span = document.createElement('span');
							span.className = 'text-sm text-neutral-500 dark:text-neutral-400';
							span.textContent = part.content;
							container.appendChild(span);
						}
					});
				}
			}
		}

		// 更新当前时间
		const currentTimeElement = document.querySelector(
			'[data-stat-id="current-time"]',
		);
		if (currentTimeElement) {
			const useAMPM = currentTimeElement.getAttribute('data-ampm') === 'true';
			
			if (useAMPM) {
				currentTimeElement.textContent = formatTimeWithAMPM(today);
			} else {
				currentTimeElement.textContent = formatTime24(today);
			}
		}
	}

	// 页面加载时更新
	updateDynamicStats();

	// 每秒更新
	setInterval(updateDynamicStats, 1000);
</script>
